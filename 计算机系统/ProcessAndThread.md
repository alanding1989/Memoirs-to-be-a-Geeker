
<!-- vim-markdown-toc GFM -->

- [概念](#概念)
- [编程模型选择](#编程模型选择)
  - [线程安全](#线程安全)

<!-- vim-markdown-toc -->


#### 概念

> 一个任务就是一个进程。  
  线程是CPU最小的执行单元，而进程由至少一个线程组成。

1. 多任务的实现有3种方式：  
    - 多进程模式  
    - 多线程模式  
    - 多进程+多线程模式  

2. 进程与线程区别：  
    - 多进程模式：  
      - 优点就是稳定性高，因为一个子进程崩溃了，不会影响主进程和其他子进程。  
       （当然主进程挂了所有进程就全挂了，但是Master进程只负责分配任务，挂掉的概率低）。  
      - 缺点是创建进程的代价大，在Unix/Linux系统下，用fork调用还行，在Windows下创建进程开销巨大。  
        另外，操作系统能同时运行的进程数也是有限的，在内存和CPU的限制下，如果有几千个进程同时运行，
        操作系统连调度都会成问题。  

   - 多线程模式：  
     - 通常比多进程快一点，但是也快不到哪去。  
        缺点就是任何一个线程挂掉都可能直接造成整个进程崩溃，因为所有线程共享进程资源，参数，内存。  
        多线程共享数据最大的危险在于多个线程同时修改一个变量，把内容改乱。因此必须要有进程锁（互斥锁）。  
        一个进程只有一个锁，同一时刻只能有一个线程持有该锁，获得锁的线程用完后一定要释放锁给其他线程用。  

     - 锁的好处就是确保某段关键代码只能由一个线程执行。  
     - 坏处是阻止了多线程并发执行，因为包含锁的某段代码实际只能以单线程模式执行，效率下降。  
        其次可以存在多个锁，不同线程持有不同锁，并试图获取对方的锁时，可能会造成死锁，导致多个线程被
        挂起。


#### 编程模型选择  

1. 线程切换：   
   线程切换会消耗系统资源，需要先进行现场保存，然后准备新的执行环境(恢复上次的寄存器状态，切换内存页等)。

2. 考虑执行任务的特点：  
  - 计算密集型：进行大量计算，主要消耗CPU资源，计算元周率，视频解码等。  
    任务同时进行的数量应等于CPU的核心数。
    代码运行效率至关重要，最好用c。

  - IO密集型：磁盘IO，网络IO等。CPU消耗资源少，大部分时间在等待IO完成。  
    任务越多，CPU效率越高。但也有个限度。
    开发效率高的语言最好，如python。

3. IO操作类型：  
   - 同步IO多线程或多进程实现并发：  
     因为CPU和IO的速度差异，一个线程中如果遇到IO操作，就要等待IO操作完成，才能进行下一步操作，这种叫同步IO。  
     因为一个IO操作就阻塞了当前线程，导致其他代码无法执行，所以必须使用多线程或多进程来并发执行代码，为多个
     用户服务。每个用户都会分配一个线程，如果遇到IO线程被挂起，其他用户的线程不受影响。

   - 异步IO实现并发：  
     多线程和多进程模型虽然解决了并发问题，但系统切换线程的开销很大，不可能无上限增加线程。
     利用操作系统提供的事件驱动模型可以进行异步IO编程，它在单核CPU上采用单进程模型就可以高效执行多任务。

     当代码需要执行一个耗时的IO操作时，它只发出IO指令，并不等待IO操作返回的结果，然后就去执行其他代码了。
     一段时间后，当IO返回结果时，再通知CPU进行处理。

4. python的**单线程**异步编程模型称为协程，可以基于事件驱动编写高效的多任务程序。  



> 同步IO模型的代码是无法实现异步IO模型的。  

> 异步IO模型需要实现一个消息循环，主线程不断处理 **读取消息，处理消息** 的过程。  
  当遇到IO操作时，代码只负责发出IO请求，不等待IO结果，然后直接结束本轮消息处理，进入下一轮消息处理过程。  
  当IO操作完成后，将收到一条 **IO完成** 的消息，处理该消息时就可以直接获取IO操作结果。  

> 在 **发出IO请求** 到收到 **IO完成** 的这段时间里，同步IO模型下，主线程只能挂起。  
  但异步IO模型下，主线程并没有休息，而是在消息循环中继续处理其他消息。这样，在异步IO模型下，一个线程就
  可以同时处理多个IO请求，并且没有切换线程的操作。对于大多数IO密集型的应用程序，使用异步IO将大大提升系统
  的多任务处理能力。  

---

##### 线程安全

1. 线程之间能够安全地共享数据的数据结构被称为线程安全的。

2. 面向对象中线程安全(thread-safe)的类有下面的三种：
    - 成员变量不可变的类。java中final修饰的，c++中const。
    - 没有成员的类，往往是工具类。java中Math。
    - 正确使用语言功能实现线程安全的类。java中正确使用synchronized的类。

